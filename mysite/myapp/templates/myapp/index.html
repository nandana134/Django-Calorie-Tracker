<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Tracker</title>

    <!-- Bootstrap & Chart.js -->
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .table-container, .chart-card {
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 350px;
        }
        canvas {
            width: 100% !important;
            height: auto !important;
        }
        @media (max-width: 992px) {
            .chart-card {
                margin-top: 20px;
            }
        }
    </style>
</head>

<body>
<div class="container-fluid p-3">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-info rounded">
        <span class="navbar-brand font-weight-bold">Calorie Tracker</span>
        <div class="ml-auto">
            <a href="{% url 'index' %}" class="navbar-brand">Home</a>
            <a href="{% url 'summary' %}" class="navbar-brand">Summary</a>
            <a href="{% url 'profile' %}" class="navbar-brand">Profile</a>
            {% if user.is_authenticated %}
                <span class="navbar-text text-white">Hello, {{ user.username }}</span>
                <a href="{% url 'logout' %}" class="btn btn-sm btn-light ml-2">Logout</a>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-sm btn-light ml-2">Login</a>
                <a href="{% url 'register' %}" class="btn btn-sm btn-light ml-2">Register</a>
            {% endif %}
        </div>
    </nav>

    {% if user.is_authenticated %}
    <br>

    <!-- Search + Add Food Section -->
    <div class="row justify-content-center">
        <div class="col-md-10">
            <form method="POST" class="form-inline justify-content-center">
                {% csrf_token %}
                <label class="mr-2 font-weight-bold">Select Food To Add:</label>
                <input type="text" class="form-control mr-2" id="foodSearch" placeholder="Search food..." onkeyup="filterDropdown()">
                <select class="form-control mr-2" name="food_consumed" id="foodDropdown" size="1">
                    {% for food in foods %}
                        <option value="{{ food.name }}">{{ food.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-success" type="submit">Add</button>
            </form>
        </div>
    </div>

    <br><h3 class="text-center">Calorie Goal</h3><br>

    <!-- Progress Bar -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-9">
            <div class="progress" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Table + Chart Section -->
    <div class="row">
        <!-- Table -->
        <div class="col-lg-7 col-md-12 table-container">
            <h4 class="text-center mb-3">Today's Consumption</h4>
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover" id="table">
                    <thead class="bg-info text-white text-center">
                        <tr>
                            <th>Food Item</th>
                            <th>Carbs (g)</th>
                            <th>Protein (g)</th>
                            <th>Fats (g)</th>
                            <th>Calories (Kcal)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody class="text-center">
                        {% for c in consumed_food %}
                        <tr data-id="{{ c.pk }}">
                            <td class="name">{{ c.food_consumed.name }}</td>
                            <td class="carbs">{{ c.food_consumed.carbs }}</td>
                            <td class="protein">{{ c.food_consumed.protein }}</td>
                            <td class="fats">{{ c.food_consumed.fats }}</td>
                            <td class="calories">{{ c.food_consumed.calories }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger delete-btn">üóëÔ∏è</button>
                            </td>
                        </tr>
                        {% endfor %}
                        <tr class="bg-info text-white font-weight-bold">
                            <td>Total</td>
                            <td id="totalCarbs"></td>
                            <td id="totalProtein"></td>
                            <td id="totalFats"></td>
                            <td id="totalCalories"></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chart -->
        <div class="col-lg-5 col-md-12 chart-card">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white text-center">
                    <h5 class="mb-0">Nutrients Breakdown</h5>
                </div>
                <div class="card-body chart-container">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="text-center mt-5">
        <h4>Please <a href="{% url 'login' %}">login</a> or <a href="{% url 'register' %}">register</a> to use the tracker.</h4>
    </div>
    {% endif %}
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Edit Food Item</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          {% csrf_token %}
          <input type="hidden" id="editId">
          <div class="form-group">
            <label>Select Food Item</label>
            <select class="form-control" id="editFoodSelect">
              {% for food in foods %}
                <option value="{{ food.id }}"
                        data-carbs="{{ food.carbs }}"
                        data-protein="{{ food.protein }}"
                        data-fats="{{ food.fats }}"
                        data-calories="{{ food.calories }}">
                  {{ food.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-success">Update</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
{% if user.is_authenticated %}

// Helper: get CSRF token from cookie (Django default)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Setup jQuery to include CSRF token for POST requests automatically
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^GET|HEAD|OPTIONS|TRACE$/i.test(settings.type)) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// Chart initialization
var ctx = document.getElementById('myChart').getContext('2d');
window.myChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Carbs 0%', 'Protein 0%', 'Fats 0%'],
        datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#ff6384', '#36a2eb', '#ffce56'],
            borderWidth: 1
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});

// Update totals + chart
function updateTotals() {
    let table = document.getElementById("table");
    let carbs = 0, protein = 0, fats = 0, calories = 0;
    for (let i = 1; i < table.rows.length - 1; i++) {
        carbs += parseFloat(table.rows[i].cells[1].innerText) || 0;
        protein += parseFloat(table.rows[i].cells[2].innerText) || 0;
        fats += parseFloat(table.rows[i].cells[3].innerText) || 0;
        calories += parseFloat(table.rows[i].cells[4].innerText) || 0;
    }

    $("#totalCarbs").text(carbs.toFixed(0) + ' g');
    $("#totalProtein").text(protein.toFixed(0) + ' g');
    $("#totalFats").text(fats.toFixed(0) + ' g');
    $("#totalCalories").text(calories.toFixed(0) + ' Kcal');

    // Progress Bar
    let calPer = (calories / 2000) * 100;
    let bar = $(".progress-bar");
    bar.css("width", calPer + "%");
    bar.removeClass("bg-success bg-warning bg-danger");
    if (calPer < 50) bar.addClass("bg-success");
    else if (calPer < 85) bar.addClass("bg-warning");
    else bar.addClass("bg-danger");

    // Chart Update
    let totalMacro = carbs + protein + fats;
    let carbsP = totalMacro ? Math.round((carbs / totalMacro) * 100) : 0;
    let proteinP = totalMacro ? Math.round((protein / totalMacro) * 100) : 0;
    let fatsP = totalMacro ? Math.round((fats / totalMacro) * 100) : 0;
    window.myChart.data.datasets[0].data = [carbsP, proteinP, fatsP];
    window.myChart.data.labels = ['Carbs ' + carbsP + '%', 'Protein ' + proteinP + '%', 'Fats ' + fatsP + '%'];
    window.myChart.update();
}
updateTotals();

// Delete Functionality
$(".delete-btn").click(function(){
    let row = $(this).closest("tr");
    let id = row.data("id");
    if(confirm("Are you sure you want to delete this item?")){
        $.ajax({
            url: `/delete/${id}/`,
            type: "POST",
            success: function(){
                row.remove();
                updateTotals();
            },
            error: function(){
                alert("Error deleting item.");
            }
        });
    }
});

// Edit Functionality
$(".edit-btn").click(function(){
    let row = $(this).closest("tr");
    $("#editId").val(row.data("id"));
    let currentFood = row.find(".name").text().trim();
    $("#editFoodSelect option").each(function(){
        $(this).prop("selected", $(this).text().trim() === currentFood);
    });
    $("#editModal").modal("show");
});

$("#editForm").submit(function(e){
    e.preventDefault();
    let id = $("#editId").val();
    let selected = $("#editFoodSelect option:selected");
    // Send 'food_id' param (view accepts food_id or food_consumed)
    $.ajax({
        url: '/edit/' + id + '/',
        type: "POST",
        data: { food_id: selected.val() },
        success: function(response){
            // If response is JSON, ensure it indicates success
            // Update the table row values
            let row = $("tr[data-id='"+id+"']");
            row.find(".name").text(selected.text());
            row.find(".carbs").text(selected.data("carbs"));
            row.find(".protein").text(selected.data("protein"));
            row.find(".fats").text(selected.data("fats"));
            row.find(".calories").text(selected.data("calories"));
            updateTotals();
            $("#editModal").modal("hide");
        },
        error: function(){
            alert("Error updating food item.");
        }
    });
});

// Search Filter
function filterDropdown() {
    let input = $("#foodSearch").val().toLowerCase();
    $("#foodDropdown option").each(function(){
        $(this).toggle($(this).text().toLowerCase().startsWith(input));
    });
    $("#foodDropdown").attr("size", input ? 5 : 1);
}

{% endif %}
</script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
